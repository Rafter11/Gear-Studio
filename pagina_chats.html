<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gear Studio â€” Chats</title>
    <link rel="stylesheet" href="css/estilos_chats.css" />
    <link rel="stylesheet" href="css/estilos_base.css">
    <link rel="shortcut icon" href="src/img/Gear_Studio_Logo_black.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body>
    <!-- Fondo de video -->
    <video autoplay muted loop id="video-fondo">
        <source src="src/video/Gears_login_video.mp4" type="video/mp4" />
    </video>
    <div class="video-overlay"></div>

    <!-- Contenedor de alertas personalizadas -->
    <div id="alert-container" class="alert-container"></div>

    <!-- Logo -->
    <div class="logo-superior-izquierda">
        <a href="/html/index.html">
            <img src="src/img/Gear_Studio_Logo_black.png" alt="Logo Gear Studio" />
        </a>
    </div>

    <!-- Usuario con icono de notificaciones -->
    <div class="usuario-superior-derecha" id="usuario-info" onclick="abrirModalPerfil()">
        <img id="usuario-avatar" class="avatar" src="" alt="Avatar" />
        <span id="usuario-nombre"></span>
        <div id="notificaciones-icono" onclick="toggleNotificaciones(event)">ðŸ””</div>
        <div id="notificaciones-lista"></div>
    </div>


    <div id="notificaciones-lista"></div>
    </div>


    <!-- Navbar -->
    <h1 class="titulo-pagina">Gear Studio â€” Chats</h1>
    <nav>
        <button onclick="location.href='pagina_principal.html'">Inicio</button>
        <button onclick="location.href='pagina_biblioteca.html'">Biblioteca</button>
        <button onclick="location.href='pagina_usuarios.html'">Amigos</button>
    </nav>

    <!-- Sidebar de chats -->
    <aside id="barra-chats">
        <h3>Mis chats</h3>
        <ul id="lista-chats"></ul>
        <button onclick="abrirModalNuevoChat()">âœš Iniciar conversaciÃ³n</button>
    </aside>

    <!-- Modal nuevo chat -->
    <div id="modal-nuevo-chat" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" onclick="cerrarModalNuevoChat()">&times;</span>
            <h2>Iniciar conversaciÃ³n</h2>
            <ul id="lista-amigos-chat"></ul>
        </div>
    </div>

    <!-- Modal de chat -->
    <div id="modal-chat" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" onclick="cerrarModalChat()">&times;</span>
            <h2 id="chat-titulo">Chat</h2>
            <div id="chat-mensajes" class="chat-mensajes"></div>
            <div class="chat-input">
                <input type="text" id="mensaje-input" placeholder="Escribe un mensaje..." />
                <button onclick="enviarMensaje()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        Gear Studio Â© 2025 â€” Todos los derechos reservados
    </footer>

    <!-- Modal de perfil -->
    <div id="modal-perfil" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" onclick="cerrarModal()">&times;</span>
            <h2>Editar Perfil</h2>
            <form id="form-editar">
                <label>Nombre</label>
                <input type="text" id="nombre" />
                <label>Correo</label>
                <input type="email" id="correo" />
                <label>Foto nueva</label>
                <input type="file" id="foto" accept="image/*" />
                <label>ContraseÃ±a</label>
                <input type="password" id="contrasena" />
                <button type="submit">Guardar cambios</button>
            </form>
        </div>
    </div>


    <script>
        const client = supabase.createClient(
            'https://ohjqmljmvufluqffhdye.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oanFtbGptdnVmbHVxZmZoZHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTcyMDIsImV4cCI6MjA3NTkzMzIwMn0.16Ii3f1iICoVlA6_ZGLfnVBQjj3MCFhK4os0Rpy_kX0'
        );

        // FunciÃ³n para mostrar alertas personalizadas
        function showAlert(message, type = 'info', duration = 4000) {
            let container = document.getElementById('alert-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'alert-container';
                container.className = 'alert-container';
                document.body.appendChild(container);
            }

            const alert = document.createElement('div');
            alert.className = `alert ${type}`;

            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            messageSpan.style.flex = '1';

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-alert';
            closeBtn.innerHTML = 'Ã—';
            closeBtn.onclick = () => {
                alert.style.animation = 'fadeOutAlert 0.4s ease-in forwards';
                setTimeout(() => alert.remove(), 400);
            };

            alert.appendChild(messageSpan);
            alert.appendChild(closeBtn);
            container.appendChild(alert);

            setTimeout(() => {
                if (alert.parentElement) {
                    alert.style.animation = 'fadeOutAlert 0.4s ease-in forwards';
                    setTimeout(() => {
                        if (alert.parentElement) alert.remove();
                    }, 400);
                }
            }, duration);
        }

        let usuarioActual = null;
        let chatActivo = null;
        let nombreChatActivo = '';
        let avatarChatActivo = '';

        function abrirModalPerfil() {
            document.getElementById("modal-perfil").style.display = "flex";
        }

        function cerrarModal() {
            document.getElementById("modal-perfil").style.display = "none";
        }

        document.getElementById("form-editar").addEventListener("submit", async function (e) {
            e.preventDefault();
            const nombre = document.getElementById("nombre").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const contrasena = document.getElementById("contrasena").value.trim();
            const archivo = document.getElementById("foto").files[0];

            const { data: { user }, error: userError } = await client.auth.getUser();
            if (userError || !user) return;

            let nuevaUrlFoto = null;
            if (archivo) {
                const nombreArchivo = `${user.id}_${Date.now()}.${archivo.name.split('.').pop()}`;
                const { error: uploadError } = await client.storage.from('fotos_perfil').upload(nombreArchivo, archivo, { cacheControl: '3600', upsert: true });
                if (uploadError) return showAlert("Error al subir la foto: " + uploadError.message, 'error', 3000);
                const { data } = client.storage.from('fotos_perfil').getPublicUrl(nombreArchivo);
                nuevaUrlFoto = data.publicUrl;
            }

            await client.from('usuario').update({
                ...(nombre && { nombre_usuario: nombre }),
                ...(correo && { email: correo }),
                ...(nuevaUrlFoto && { imagen_perfil: nuevaUrlFoto }),
                ...(contrasena && { contrasena: contrasena })
            }).eq('id_usuario', user.id);

            if (correo || contrasena) {
                await client.auth.updateUser({
                    ...(correo && { email: correo }),
                    ...(contrasena && { password: contrasena })
                });
            }

            if (nuevaUrlFoto) document.getElementById('usuario-avatar').src = nuevaUrlFoto;
            if (nombre) document.getElementById('usuario-nombre').textContent = nombre;
            cerrarModal();
        });

        function toggleNotificaciones(event) {
            event.stopPropagation();
            const lista = document.getElementById('notificaciones-lista');
            const visible = lista.style.display === 'block';
            lista.style.display = visible ? 'none' : 'block';

            if (!visible) {
                cargarNotificacionesUsuario();
                marcarNotificacionesComoLeidas();
            }
        }

        document.addEventListener('click', () => {
            const lista = document.getElementById('notificaciones-lista');
            if (lista) lista.style.display = 'none';
        });

        async function mostrarUsuario() {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;
            usuarioActual = user;

            const { data: perfil } = await client
                .from('usuario')
                .select('nombre_usuario, imagen_perfil')
                .eq('id_usuario', user.id)
                .single();

            document.getElementById('usuario-nombre').textContent = perfil?.nombre_usuario || user.email;
            document.getElementById('usuario-avatar').src =
                perfil?.imagen_perfil || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(perfil?.nombre_usuario || user.email));

            cargarChats();
        }

        async function cargarChats() {
            const amigosGuardados = localStorage.getItem("misAmigos");
            const ul = document.getElementById('lista-chats');
            ul.innerHTML = '';

            if (!amigosGuardados) {
                ul.innerHTML = '<li>No tienes amigos todavÃ­a</li>';
                return;
            }

            const amigosIds = JSON.parse(amigosGuardados);
            if (!Array.isArray(amigosIds) || amigosIds.length === 0) {
                ul.innerHTML = '<li>No tienes amigos todavÃ­a</li>';
                return;
            }

            for (const id of amigosIds) {
                const { data: perfil } = await client
                    .from('usuario')
                    .select('nombre_usuario, imagen_perfil')
                    .eq('id_usuario', id)
                    .single();

                if (perfil) {
                    const li = document.createElement('li');
                    li.textContent = perfil.nombre_usuario;
                    li.onclick = () => abrirChat(id, perfil.nombre_usuario, perfil.imagen_perfil);
                    ul.appendChild(li);
                }
            }
        }

        function abrirChat(idAmigo, nombreAmigo, avatarAmigo) {
            chatActivo = idAmigo;
            nombreChatActivo = nombreAmigo;
            avatarChatActivo = avatarAmigo || '';
            document.getElementById('chat-titulo').textContent = `Chat con ${nombreAmigo}`;
            document.getElementById('modal-chat').style.display = 'flex';
            cargarMensajes(idAmigo, nombreAmigo, avatarAmigo);
        }

        function cerrarModalChat() {
            document.getElementById('modal-chat').style.display = 'none';
            chatActivo = null;
            nombreChatActivo = '';
            avatarChatActivo = '';
        }

        async function cargarMensajes(idAmigo, nombreAmigo, avatarAmigo) {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            const { data: mensajes, error } = await client
                .from('mensaje')
                .select('contenido, id_emisor, fecha_envio')
                .or(`and(id_emisor.eq.${user.id},id_receptor.eq.${idAmigo}),and(id_emisor.eq.${idAmigo},id_receptor.eq.${user.id})`)
                .order('fecha_envio', { ascending: true });

            if (error) {
                console.error("Error al cargar mensajes:", error.message);
                return;
            }

            const contenedor = document.getElementById('chat-mensajes');
            contenedor.innerHTML = '';
            (mensajes || []).forEach(m => {
                const div = document.createElement('div');
                div.className = `mensaje ${m.id_emisor === user.id ? 'tuyo' : 'amigo'}`;
                const avatarUrl = m.id_emisor === user.id
                    ? (document.getElementById('usuario-avatar').src || 'https://ui-avatars.com/api/?name=TÃº')
                    : (avatarAmigo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(nombreAmigo));
                div.innerHTML = `
          <img class="avatar-msg" src="${avatarUrl}" alt="avatar" />
          <div class="contenido">
            <strong>${m.id_emisor === user.id ? 'TÃº' : nombreAmigo}:</strong>
            ${m.contenido}
            <br><small>${new Date(m.fecha_envio).toLocaleString()}</small>
          </div>
        `;
                contenedor.appendChild(div);
            });
        }

        async function enviarMensaje() {
            const contenido = document.getElementById('mensaje-input').value.trim();
            if (!contenido || !chatActivo) return;

            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            await client.from('mensaje').insert({
                id_emisor: user.id,
                id_receptor: chatActivo,
                contenido,
                fecha_envio: new Date().toISOString()
            });

            document.getElementById('mensaje-input').value = '';
            // Reusar el nombre y avatar activos para pintar correctamente
            cargarMensajes(chatActivo, nombreChatActivo, avatarChatActivo);
        }

        function abrirModalNuevoChat() {
            const amigosGuardados = localStorage.getItem("misAmigos");
            const lista = document.getElementById("lista-amigos-chat");
            lista.innerHTML = '';

            if (!amigosGuardados) {
                lista.innerHTML = '<li>Debes tener al menos 1 amigo para iniciar una conversaciÃ³n.</li>';
            } else {
                const amigosIds = JSON.parse(amigosGuardados);
                if (!Array.isArray(amigosIds) || amigosIds.length === 0) {
                    lista.innerHTML = '<li>Debes tener al menos 1 amigo para iniciar una conversaciÃ³n.</li>';
                } else {
                    amigosIds.forEach(async id => {
                        const { data: perfil } = await client
                            .from('usuario')
                            .select('nombre_usuario, imagen_perfil')
                            .eq('id_usuario', id)
                            .single();

                        if (perfil) {
                            const li = document.createElement('li');
                            li.innerHTML = `
                <img src="${perfil.imagen_perfil || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(perfil.nombre_usuario)}"
                     style="width:24px;height:24px;border-radius:50%;margin-right:8px;vertical-align:middle;" />
                ${perfil.nombre_usuario}
                <button onclick="abrirChat('${id}', '${perfil.nombre_usuario.replace(/'/g, "\\'")}', '${(perfil.imagen_perfil || '').replace(/'/g, "\\'")}')">Iniciar chat</button>
              `;
                            lista.appendChild(li);
                        }
                    });
                }
            }

            document.getElementById("modal-nuevo-chat").style.display = "flex";
        }

        function cerrarModalNuevoChat() {
            document.getElementById("modal-nuevo-chat").style.display = "none";
        }

        async function cargarNotificacionesUsuario() {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            const { data: notificaciones, error } = await client
                .from('notificacion')
                .select('tipo, mensaje, fecha, leida')
                .eq('id_usuario', user.id)
                .order('fecha', { ascending: false });

            const lista = document.getElementById('notificaciones-lista');
            lista.innerHTML = '';

            if (error || !notificaciones || notificaciones.length === 0) {
                lista.innerHTML = '<div class="notificacion-item">No tienes notificaciones</div>';
                return;
            }

            notificaciones.forEach(n => {
                const item = document.createElement('div');
                item.className = 'notificacion-item';
                item.innerHTML = `
                    <strong>${n.tipo}</strong><br>
                    ${n.mensaje}<br>
                    <small>${new Date(n.fecha).toLocaleString()}</small>
                `;
                if (!n.leida) item.style.fontWeight = 'bold';
                lista.appendChild(item);
            });

            // Actualiza el contador en la campana
            const noLeidas = notificaciones.filter(n => !n.leida).length;
            document.getElementById('notificaciones-icono').textContent = `ðŸ”” (${noLeidas})`;
        }

        async function marcarNotificacionesComoLeidas() {
            const { data: { user } } = await client.auth.getUser();
            if (!user) return;

            await client
                .from('notificacion')
                .update({ leida: true })
                .eq('id_usuario', user.id)
                .eq('leida', false);
        }

        mostrarUsuario();
        cargarNotificacionesUsuario();
    </script>
</body>

</html>